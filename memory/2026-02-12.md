# 2026-02-12

## Khal Timeout Fix
- Khal's WhatsApp instance (`0567bded-23f6-439f-b49f-773fa7f47419`) was hitting "taking longer than expected" errors
- **Root cause:** `agentTimeout` was 60s, but Khal runs on `claude-opus-4-6` with 315K/400K token context â€” easily exceeds 60s
- **Fix:** Bumped `agentTimeout` from 60s â†’ 180s via production API (`https://felipe.omni.namastex.io`)
- Khal's session is dangerously stuffed at 315K tokens â€” may need compaction/reset if slowness persists
- `agentStreamMode: false` on Khal â€” streaming would improve UX but depends on stream-telegram wish

## Infrastructure Notes
- CLI config points to **production** API at `https://felipe.omni.namastex.io` (not localhost)
- Local DB (`postgresql://postgres:postgres@localhost:18433/omni`) is empty (dev instance, never seeded)
- API key for production: stored in CLI config (`omni config list`)
- Auth header: `x-api-key` (not `Authorization: Bearer`)
- PM2 processes: omni-v2-api, omni-v2-nats, omni-v2-pgserve, genie-os, genie-os-dev, khal-server, khal-frontend, term-bridge, totvs-api, totvs-ui
- API port: 18882 (env `API_PORT`)

## Stream Plumbing Status
- `stream-plumbing` wish marked COMPLETE but **changes are uncommitted** on `dev` branch (380 lines, 10 files)
- Files: provider.ts (triggerStream AsyncGenerator), client.ts (agent event routing), types.ts (StreamDelta/AgentEventPayload), channel-sdk types (StreamSender interface)
- `stream-telegram` wish is READY (depends on stream-plumbing)

## Nightly /goodnight Autonomy Protocol (Felipe)
- Felipe wants **autonomous nightly execution**: he will send `/goodnight` every day
- Agent should pick **everything it can deliver without asking**, as long as it follows the **Genie wish protocol**
- Deliver **one PR per night** targeting `dev` (nightly branch â†’ PR to dev), by **morning (9â€“11am)**
- Each night must include **at least one quick win** (lint/cleanup/optimization/security/dead code/etc.)
- Branch naming OK: `nightly/*` / `night/*` / `owl/*` (pick one and standardize)
- Future: create "teams of octopuses" (focus areas: security, dead code, lint, optimization, token saving, etc.)

## Nightly Backlog (Sleepyhead Queue)
1. **[SHIPPED]** `stream-telegram` â€” TelegramStreamSender + dispatcher streaming path (PR #23)
2. **[QUEUED]** Full bilateral feature parity audit: Telegram â†” WhatsApp
   - Map every feature each platform supports via their libs (grammy vs baileys)
   - Identify gaps: what Telegram has that WhatsApp doesn't, and vice versa
   - Match equivalents: reactions, read receipts, typing, media types, groups, threads/topics, buttons/inline keyboards, polls, contacts, location, stickers, voice messages, etc.
   - Plan: streaming for WhatsApp too (WhatsApp doesn't support editMessage natively â€” need alternative UX like "typing..." â†’ final message, or WhatsApp Web edit API if available)
   - The night task output: a full wish document mapping both channels to 100% feature parity where platform allows
   - This IS an Omni superpower: translate any feature across any messaging system. Emoji reactions, file systems, presence, receipts â€” every system has its feature set, Omni bridges them all.

## Khal's Last Activity
- Khal was mapping Felipe's two WhatsApp numbers (+5512982298888 and +5511986780008) to same person
- Updated contacts.json and MEMORY.md in khal repo
- "Human Board" group deprecated in favor of "Khal - Dev" group
- Omni doesn't have person merge feature yet â€” both numbers remain separate persons in DB

## ðŸš¨ Khal WhatsApp Disconnected (device_removed) â€” ~07:48 UTC
- **Root cause:** WhatsApp sent `stream:error` code 401, conflict type `device_removed`
- The linked device Khal was using got removed (either manually from phone or by WhatsApp)
- Baileys logged: `wasLoggedOut: true`, `willReconnect: false`
- Instance marked `isActive: false` â€” Khal is **completely offline**
- All outbound send attempts fail with `Instance 0567bded not connected`
- Last successful inbound event: ~11:31 UTC (messages still arrive to Omni but can't be replied to)
- **Fix required:** Felipe must re-scan QR code via `omni instances connect 0567bded-...`
- This is a physical action â€” no code fix possible, needs phone access
- Felipe was told at 12:35 BRT; people are relying on Khal now

## Recurring Bug: UUID Parse Error on Group JID
- Every ~5 minutes, API throws `invalid input syntax for type uuid: "120363424660366845@g.us"`
- Some code path is passing a WhatsApp group JID where a Postgres UUID column is expected
- Pre-existing issue, not caused by the disconnect â€” been in logs all day
- Not blocking but very noisy; should be filed as a bug

## Production PM2 Status (as of 12:35 BRT)
- Only 3 PM2 processes on omni@10.114.1.140: omni-v2-api (21h uptime, 42 restarts), omni-v2-nats (2D), omni-v2-pgserve (5D)
- Previous note listed more PM2 processes (khal-server, genie-os, etc.) â€” those may be on a different host or were stopped
- SSH to prod: `ssh omni@10.114.1.140`, pm2 at `/home/omni/.bun/bin/pm2`

## Khal Smart Response Gate â€” Fully Shipped
- Reviewed the QA report: all Groups Aâ€“E completed and validated
- Features live: allowlist mode, per-chat sessions, name match with LLM gate, per-context debounce (60s DM / 5min group)
- Gate uses flash model, fail-open, bypassed on @mention/reply
- All working perfectly UNTIL the device got removed today
