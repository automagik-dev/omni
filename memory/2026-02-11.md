# 2026-02-11

## Brainstorm: Telegram Reasoning Stream via Omni

**Initiated by:** Cezão (Cezar's agent) — brought a detailed user story at `/home/genie/workspace/cezao/user-stories/omni-telegram-reasoning-stream.md`

### Problem
Omni's OpenClaw provider uses accumulate-then-reply — user sees "typing..." for 10-60s then a text wall. Thinking tokens from the gateway are discarded. Bad UX.

### Key Codebase Findings
- `agentStreamMode` boolean **already exists** in DB schema (`packages/db/src/schema.ts:454`), API, tRPC, SDK — just unused
- `ChatMessage.thinking` + `ContentBlock.thinking` types already defined in `packages/core/src/providers/openclaw/types.ts`
- `extractText()` in `provider.ts` filters `type === 'text'` only — thinking discarded
- `registerAccumulation(runId, callback)` in `client.ts` already receives every delta in real-time — data flows but gets accumulated not forwarded
- Telegram sender already has `editTextMessage()` and `deleteMessage()` in `packages/channel-telegram/src/senders/text.ts`

### Architecture Options Discussed
- **A) Callback injection** — Dispatcher passes `StreamingCallback` into `provider.triggerStreaming()`. (What user story proposed)
- **B) AsyncGenerator** ← My recommendation — `triggerStreaming()` returns `AsyncGenerator<StreamDelta>`, dispatcher consumes and routes to channel-specific `StreamSender` interface
- **C) Event bus (NATS)** — Provider publishes stream deltas to NATS, channels subscribe independently. Event-first but overkill for real-time streaming.

### UX Options (from user story)
- **A) Expandable blockquote** (recommended) — `<blockquote expandable>` (Bot API 7.10+)
- **B) Separate message** for thinking
- **C) Spoiler tag** — `<tg-spoiler>`
- **D) No thinking, stream response only** — simplest

### Status
Brainstorm in progress — asked Cezão which architecture approach resonates. Awaiting response. No design document written yet.

### Files Explored
- `packages/core/src/providers/openclaw/provider.ts` — accumulate-then-reply logic
- `packages/core/src/providers/openclaw/types.ts` — ChatMessage/ContentBlock with thinking fields
- `packages/core/src/providers/openclaw/client.ts` — registerAccumulation callback mechanism
- `packages/core/src/providers/types.ts` — IAgentProvider interface (only has sync `trigger()`)
- `packages/channel-telegram/src/senders/text.ts` — sendTextMessage, editTextMessage, deleteMessage
- `packages/api/src/plugins/agent-dispatcher.ts` — full dispatch flow, provider resolution
