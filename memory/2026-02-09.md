# 2026-02-09 ‚Äî Day Three: Deploy, QA Disaster, Recovery

## What Happened

### Deploy to Production
- Cegonha deployed all PRs (#6, #7, #9, #10, #11) + configured CI/CD Jenkins
- Production: `https://felipe.omni.namastex.io` ‚Äî CT 140 at `10.114.1.140`
- CI/CD: push to main ‚Üí Jenkins ‚Üí SSH to CT 140 ‚Üí git pull ‚Üí build ‚Üí pm2 restart
- Helena profile renamed to "Helena" via API ‚úÖ

### PR #8 ‚Üí PR #10 (Conflict Resolution)
- PR #8 had irrecoverable merge conflicts (3 files, 9+ conflict blocks)
- Council voted 8/10 for manual merge resolve
- After failed attempts, used **fresh branch from main + `git diff | git apply`** ‚Äî worked in 2 minutes
- PR #10 created and squash-merged cleanly
- **Lesson**: when merge conflicts are irrecoverable, fresh branch + diff apply is the nuclear option that works

### groupCreate Feature (PR #11)
- Implemented for Helena: plugin + API (`POST /instances/:id/groups`) + CLI
- Also fixed @ mentions: stopped prepending `@phone`, added mentions to image/video captions
- Merged same day

### Production QA Disaster
- Tested all new features via API against production
- **Burst 10+ API calls in seconds** through Genie instance
- WhatsApp anti-bot detection triggered ‚Üí **Genie instance force-logged out**
- **Helena instance also killed** ‚Äî `stream:error code=401 type=device_removed`
- Both need QR re-scan to reconnect

### Root Cause: No Rate Limiting
- Evolution API (old backend) used RabbitMQ to enqueue with delays
- Omni v2 sends directly to Baileys socket ‚Äî no throttle
- WhatsApp detects inhuman action patterns and force-disconnects
- **This is a real platform bug**, not just my mistake

### Humanized Action Delay (PR #12) ‚Äî URGENT FIX
- Added `humanDelay()`: 1.5-3.5s random delay between all outgoing actions per instance
- Added `simulateTyping()`: composing presence before text messages, scales with text length
- Applied to ALL 17 outgoing plugin methods
- Read-only ops (fetchBlocklist) not delayed
- **Deployed to production** via manual SSH before QR re-scan

### SSH Access Granted
- `ssh omni@10.114.1.140` ‚Äî genie-os key added to CT 140 (Omni production)
- PM2 path: `$HOME/.bun/bin:$HOME/.bun/install/global/node_modules/.bin`
- Cegonha's rules: Omni never dies, always monitor logs, never pm2 delete/kill

### Omni Native Agent (Wish ‚Äî Backlog)
- Felipe likes the idea of Omni being a first-class agent INSIDE the platform
- Option A (native agent) saved to backlog for terms discussion
- Option C (SSH access) implemented as stepping stone
- `.wishes/omni-native-agent/omni-native-agent-wish.md` created

## Baileys Deep Dive (Homework)
- Created `docs/BAILEYS-JID-MENTIONS-GROUPS.md` ‚Äî comprehensive reference
- JID system: PN (@s.whatsapp.net) vs LID (@lid) ‚Äî Omni assumes PN everywhere
- Mentions: need both `mentions[]` array AND `@phone` in text
- Groups: `sock.groupCreate(subject, participants)` ‚Üí GroupMetadata
- Felipe's chat uses LID addressing mode (`54958418317348@lid`)

## Critical Lessons

### Anti-Bot Protection
- WhatsApp monitors action timing patterns
- Inhuman bursts trigger force logout / device removal
- **ALWAYS add delays between API calls** ‚Äî minimum 1.5s
- **ALWAYS stream logs** during any production operation
- "Behave humanly probable" ‚Äî Felipe's exact words

### Production Is Sacred
- Cegonha: "O Polvo NUNCA morre"
- Never `pm2 delete` or `pm2 kill` ‚Äî only `pm2 restart`
- Test with caution ‚Äî delays between operations, monitor in real-time
- If something breaks, notify IMMEDIATELY

### Infrastructure Notes
- `api_key_audit_logs` table missing ‚Äî needs `bun run db:push` on prod
- Genie bio changed to "üêô Omni v2 ‚Äî Universal Event-Driven Octopus" (may need revert)
- 3/5 instances connected (felipe-pessoal, namastex, charlinho OK)
- Genie + Helena need QR re-scan ‚Äî HANDOFF.md has steps

## PRs Merged Today
- PR #10: C-series features (was #8, fresh branch)
- PR #11: groupCreate + fix mentions
- PR #12: humanized action delay (anti-bot)

## Open Items
- [ ] Re-scan QR for Genie + Helena instances
- [ ] Run `bun run db:push` on prod (audit_logs table)
- [ ] Fix CI/CD Jenkins (didn't auto-deploy PR #12)
- [ ] Discuss Omni Native Agent terms (Option A)
- [ ] Test all features properly WITH log streaming and delays
