# 2025-02-11 — Reasoning Stream Brainstorm with Cezão

## Context
Cezão (Cezar's collaborator) brought a user story for real-time reasoning/thinking stream on Telegram via Omni. We'd previously agreed on AsyncGenerator approach (option B). This session was the deep technical brainstorm to finalize the design.

## Key Decisions Made

### 1. StreamDelta Type Shape → Discriminated Union (Approach A)
```typescript
type StreamDelta =
  | { phase: 'thinking'; thinking: string; thinkingElapsedMs: number }
  | { phase: 'content'; content: string; thinking?: string; thinkingDurationMs?: number }
  | { phase: 'final';   content: string; thinking?: string; thinkingDurationMs?: number }
  | { phase: 'error';   error: string };
```
- Cumulative snapshots (not incremental diffs) — matches gateway behavior
- TypeScript narrowing per phase

### 2. StreamSender Interface → Factory Pattern (Option A)
- `createStreamSender?(instanceId, chatId, replyTo?)` on `ChannelPlugin`
- Returns `StreamSender` with per-phase methods: `onThinkingDelta`, `onContentDelta`, `onFinal`, `onError`, `abort`
- Dispatcher pipes AsyncGenerator deltas into sender methods

### 3. 4096 Telegram Limit → Tail Window + Final Replace (Option D)
- During stream: single message, sliding tail window (~3800 chars) when content exceeds limit
- On final: edit msg 1 to chunk 1, send remaining chunks as new messages via existing `splitMessage()`

## Critical Finding: Thinking IS Broadcast via WebSocket
- Cezão initially reported `onReasoningStream` never reaches agent events bus
- **I found in `pi-embedded-subscribe.ts:544`**: `emitAgentEvent({ stream: "thinking", data: {text, delta} })` — IT IS EMITTED
- In `server-chat.ts`: all non-tool events are `broadcast("agent", payload)` to ALL operators
- Cezão confirmed — he missed it because his test session had `reasoning=off`
- This means Omni already receives thinking events over WS, just ignores them

## Architecture: 3-Phase Plan (Revised from Original 4)
1. **Client** — Route `agent` events by runId (not just `chat`). Add `caps: ['tool-events']` to connect handshake
2. **Provider** — New `triggerStream()` AsyncGenerator method. Maps agent event streams to StreamDelta phases
3. **Dispatcher + Telegram** — StreamSender in channel-sdk, TelegramStreamSender implementation, dispatcher orchestration

## Event Map (What Omni Gets Over WS)
| Event | Stream | Omni Receives | Omni Currently Uses |
|-------|--------|--------------|-------------------|
| `agent` | `thinking` | ✅ broadcast | ❌ ignored |
| `agent` | `assistant` | ✅ broadcast | ❌ ignored |
| `agent` | `tool` | ❌ needs `tool-events` cap | ❌ |
| `agent` | `lifecycle` | ✅ broadcast | ❌ ignored |
| `chat` | delta/final | ✅ | ✅ accumulated |

## Artifacts
- Design doc: `.genie/brainstorms/reasoning-stream/design.md` (STATUS: VALIDATED)
- User story: `/home/genie/workspace/cezao/user-stories/omni-telegram-reasoning-stream.md`
- OpenClaw source research: `/home/genie/research/openclaw/`

## Wish Creation + Council Review + Split

### Monolithic Wish (v1)
- Created `.genie/wishes/reasoning-stream/wish.md` with 5 groups, 6 tasks
- Covered all 3 phases in one wish

### Council Review (unanimous MODIFY — 6/6)
- **questioner**: Different risk profiles across groups, natural split at package boundary
- **simplifier**: Task 4.1 (TelegramStreamSender) mixes lifecycle + formatting concerns — split it
- **architect**: Context window argument — provider worker needs OpenClaw knowledge, Telegram worker needs Bot API knowledge. Separate wishes = focused context per worker
- **operator**: Ship foundation first, iterate on Telegram formatting without rebase risk
- **ergonomist**: `splitMessage()` could break HTML tags — thinking blockquote must always go in msg 1
- **tracer**: Add structured logging for stream lifecycle phases (observability gap)

### Final Split (Cezão's slugs)
1. **`stream-plumbing`** (`.genie/wishes/stream-plumbing/wish.md`) — READY
   - Types (StreamDelta, AgentEventPayload)
   - Client: route agent events by runId + tool-events cap
   - channel-sdk: StreamSender interface + canStreamResponse
   - Provider: triggerStream() AsyncGenerator
   - 3 groups, 4 tasks, 35 acceptance criteria
   
2. **`stream-telegram`** (`.genie/wishes/stream-telegram/wish.md`) — READY (depends on plumbing)
   - TelegramStreamSender (lifecycle + formatting)
   - Dispatcher streaming orchestration
   - Integration tests
   - 3 groups, 3 tasks, 34 acceptance criteria

### Council-Driven Improvements Applied
- Task 4.1 split concept (lifecycle vs formatting) — Cezão kept as single task but cleaner
- Observability criteria added to provider and dispatcher tasks
- HTML-safe splitting documented: thinking blockquote always in msg 1 header
- Cezão added decision #8: skip thinking display if < 2s (avoid noise for fast responses)

### File Layout
```
.genie/wishes/
├── reasoning-stream/README.md              ← feature index
├── reasoning-stream/wish-v1-monolithic.md  ← archived original
├── stream-plumbing/wish.md                 ← READY
└── stream-telegram/wish.md                 ← READY (blocked on plumbing)
.genie/brainstorms/reasoning-stream/design.md ← VALIDATED design
```

## `/make` Execution — stream-plumbing COMPLETE ✅

### Execution Timeline
- Spawned G1 (types + client) and G2 (channel-sdk) in parallel
- G1 sub-agent completed types but **missed Task 1.2** (client routing) — had to dispatch separately
- G2 sub-agent completed with smart placeholder for StreamDelta (parallel dependency handling)
- Fixed manually: missing exports in index files, placeholder→real import, caps `['tool-events']`, missing `flushAgentAccumulations()` method
- G3 (provider triggerStream) dispatched after G1+G2 landed — completed clean

### Quality Review: FIX-FIRST → Fixed → SHIP
Two high-severity findings caught by quality reviewer:
1. **Unbounded queue in triggerStream()** — fixed with MAX_QUEUE_SIZE=100, safe because cumulative snapshots
2. **Circuit breaker not opened in triggerStream()** — aligned with trigger()'s failure counting logic
3. **Bonus:** Added generator.return() cleanup test

### Lessons Learned
- Sub-agents sometimes skip tasks even when clearly listed — always verify deliverables against task list
- Export wiring through barrel files (index.ts) is frequently missed by sub-agents — need to verify manually
- The quality review caught real bugs that spec review missed (unbounded queue, circuit breaker semantics)
- Parallel sub-agents handling cross-package dependencies need fallback strategies (placeholder types worked well)

### Final Stats
- 10 files changed, 380 lines added, 0 regressions
- 381 core tests (5 new stream tests), 45 channel-sdk tests — all passing
- Typecheck passes across all 14 packages

## Next Steps
- `stream-plumbing` → COMPLETE
- `stream-telegram` → READY (unblocked), waiting for `/make`
- Need to commit + push the stream-plumbing changes

## People
- **Cezão** — Did excellent OpenClaw source code research, mapped all event flows, identified the key source files. Communicates in Portuguese, technical discussions in English. Knows the OpenClaw codebase well. Also did his own wish split with cleaner slugs (stream-plumbing / stream-telegram).
- **Cezar** — Approved the plan. Requested the split into 2 wishes. Gave final go to execute.
